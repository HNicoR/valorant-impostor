<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>El Impostor de Valorant</title>
</head>
<body>
  <h1>El Impostor de Valorant</h1>
  <div id="form">
    <textarea id="nombres" rows="5" cols="30" placeholder="Escrib√≠ los nombres, uno por l√≠nea..."></textarea><br>
    <button onclick="generarRoles()">Generar roles</button>
  </div>
  <div id="links"></div>

  <!-- Firebase SDKs (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // Configuraci√≥n Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDpc09bgU2y-dd2JG5CoBIfrusE5-rs1eM",
      authDomain: "valorant-impostor.firebaseapp.com",
      projectId: "valorant-impostor",
      storageBucket: "valorant-impostor.appspot.com",
      messagingSenderId: "454058428975",
      appId: "1:454058428975:web:d15ad7304ff829bcb054da",
      measurementId: "G-62TQV7RBJ8"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const agentes = ["Jett", "Phoenix", "Raze", "Sage", "Reyna", "Yoru"];

    async function generarRoles() {
      const nombres = document.getElementById("nombres").value.trim().split("\n").filter(n => n);
      if (nombres.length < 2) {
        alert("¬°Se necesitan al menos 2 jugadores!");
        return;
      }

      const impostorIndex = Math.floor(Math.random() * nombres.length);
      const agente = agentes[Math.floor(Math.random() * agentes.length)];
      const partidaRef = db.collection("partidas").doc();
      const partidaId = partidaRef.id;

      const roles = {};

      nombres.forEach((nombre, i) => {
        roles[nombre] = {
          nombre,
          rol: i === impostorIndex ? "Impostor" : "Agente",
          agente: i === impostorIndex ? null : agente
        };
      });

      await partidaRef.set({ roles });

      const linksContainer = document.getElementById("links");
      linksContainer.innerHTML = "<h2>Links para compartir:</h2>";
      Object.keys(roles).forEach(nombre => {
        const input = document.createElement("input");
        input.type = "text";
        input.readOnly = true;
        input.style.width = "100%";
        input.value = `${location.origin + location.pathname}?sala=${partidaId}&nombre=${encodeURIComponent(nombre)}`;
        linksContainer.appendChild(input);
        linksContainer.appendChild(document.createElement("br"));
      });
    }

    async function mostrarRol(nombre, salaId) {
      try {
        const doc = await db.collection("partidas").doc(salaId).get();
        if (!doc.exists) {
          document.body.innerHTML = "<h2>Rol no encontrado.</h2>";
          return;
        }

        const data = doc.data();
        const rolInfo = data.roles?.[nombre];
        if (!rolInfo) {
          document.body.innerHTML = "<h2>Nombre no v√°lido o expirado.</h2>";
          return;
        }

        const mensaje = rolInfo.rol === "Impostor"
          ? "Sos el IMPOSTOR üïµÔ∏è‚Äç‚ôÇÔ∏è. Elimin√° a los agentes sin que te descubran."
          : `Sos un AGENTE: ${rolInfo.agente} üî´. Encontr√° al impostor.`;

        document.body.innerHTML = `<h2>${mensaje}</h2>`;
      } catch (e) {
        document.body.innerHTML = "<h2>Error al cargar los datos.</h2>";
      }
    }

    // Si hay par√°metros en la URL
    const params = new URLSearchParams(window.location.search);
    const sala = params.get("sala");
    const nombre = params.get("nombre");
    if (sala && nombre) {
      mostrarRol(nombre, sala);
    }
  </script>
</body>
</html>
