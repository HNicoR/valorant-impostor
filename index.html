<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>El Impostor de Valorant</title>
</head>
<body>
  <h1>El Impostor de Valorant</h1>
  <form id="form">
    <input type="text" id="nombres" placeholder="Ej: Nico, Juju, Pepe" size="40">
    <button type="submit">Generar Ronda</button>
  </form>
  <div id="links"></div>

  <!-- Firebase SDKs compatibles con navegadores normales -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDpc09bgU2y-dd2JG5CoBIfrusE5-rs1eM",
      authDomain: "valorant-impostor.firebaseapp.com",
      projectId: "valorant-impostor",
      storageBucket: "valorant-impostor.appspot.com",
      messagingSenderId: "454058428975",
      appId: "1:454058428975:web:d15ad7304ff829bcb054da",
      measurementId: "G-62TQV7RBJ8"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const form = document.getElementById("form");
    const input = document.getElementById("nombres");
    const linksDiv = document.getElementById("links");

    const agentes = ["Jett", "Phoenix", "Sage", "Sova", "Killjoy", "Reyna", "Brimstone"];

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      linksDiv.innerHTML = "Generando ronda...";

      const nombres = input.value.split(",").map(n => n.trim()).filter(n => n);
      if (nombres.length < 2) {
        linksDiv.innerHTML = "Necesitás al menos 2 jugadores.";
        return;
      }

      const salaId = Math.random().toString(36).substring(2, 10);
      const impostorIndex = Math.floor(Math.random() * nombres.length);
      const agente = agentes[Math.floor(Math.random() * agentes.length)];

      const salaRef = db.collection("salas").doc(salaId);
      await salaRef.set({ timestamp: Date.now() });

      const roles = {};
      nombres.forEach((nombre, i) => {
        roles[nombre] = i === impostorIndex ? "Impostor" : agente;
      });

      await salaRef.collection("jugadores").doc("roles").set(roles);

      // Mostrar links anónimos
      linksDiv.innerHTML = "";
      nombres.forEach(nombre => {
        const input = document.createElement("input");
        input.type = "text";
        input.readOnly = true;
        input.value = `${location.origin}${location.pathname}?sala=${salaId}&nombre=${encodeURIComponent(nombre)}`;
        input.style.marginBottom = "10px";
        input.style.width = "100%";
        linksDiv.appendChild(input);
        linksDiv.appendChild(document.createElement("br"));
      });
    });

    // Mostrar rol si se accede por link
    const params = new URLSearchParams(location.search);
    const sala = params.get("sala");
    const nombre = params.get("nombre");

    if (sala && nombre) {
      db.collection("salas").doc(sala).collection("jugadores").doc("roles")
        .get().then(doc => {
          if (!doc.exists) {
            document.body.innerHTML = "<h2>Rol no encontrado o sala expirada.</h2>";
            return;
          }
          const data = doc.data();
          const rol = data[nombre];
          if (!rol) {
            document.body.innerHTML = "<h2>Nombre no encontrado.</h2>";
            return;
          }

          document.body.innerHTML = `
            <h1>Tu rol:</h1>
            <h2 style="font-size: 3em">${rol}</h2>
          `;
        });
    }
  </script>
</body>
</html>
